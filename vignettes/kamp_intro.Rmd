---
title: "Introduction to KAMP"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to KAMP}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction
Hello and welcome to the `KAMP` package! 
This package is designed to calculate the expectation and variance of KAMP (K adjustment by Analytical Moments of the Permutation distribution) for point patterns with marks. The package is partially built on the `spatstat` package, which is a powerful tool for analyzing spatial data in R.
The `KAMP` package provides functions to simulate point patterns, calculate the KAMP CSR, and visualize the results. The package is designed to be user-friendly and easy to use, with a focus on providing clear and concise output.
The package is still in development, and we welcome any feedback or suggestions for improvement. If you have any questions or issues, please feel free to reach out to us.

# Setup
```{r}
library(KAMP)
#library(devtools)
library(tidyverse)
library(spatstat.random)
#devtools::load_all()
set.seed(50)
```

# Simulating Data
The `sim_pp_data` function can be used to simulate univariate point patterns, while the `sim_pp_data_biv` function can be used to simulate bivariate point patterns.

The `sim_pp_data` function takes the following arguments:

- `lambda_n`: The number of points to simulate.

- `abundance`: The abundance of the point pattern.

- `markvar1`: The name of the first cell type. Defaults to "immune".

- `markvar2`: The name of the second cell type. Defaults to "background".

- `distribution`: The distribution of the point pattern. This can be either "hom" for homogeneous or "inhom" for inhomogeneous.

- `clust`: A logical value indicating whether to cluster the points or not.


The `sim_pp_data_biv` function takes the same arguments as `sim_pp_data`, but also includes an additional argument for the third cell type.

- `markvar3`: The name of the third cell type. Defaults to "background".

The `sim_pp_data` and `sim_pp_data_biv` functions return a `ppp` object, which is a class in the `spatstat` package that represents a point pattern. The `ppp` object contains the x and y coordinates of the points, as well as the marks associated with each point.

## Univariate

```{r}
univ_data <- sim_pp_data(lambda_n = 200, 
                    abundance = 0.3,
                    markvar1 = "immune",
                    markvar2 = "background",
                    distribution = "hom",
                    clust = FALSE)

```

We can plot this using `ggplot`:

```{r}
as_tibble(univ_data) %>%
    ggplot(aes(x,y, color = marks)) +
    geom_point()
```

## Bivariate
```{r}
biv_data <- sim_pp_data_biv(lambda_n = 200, 
                    abundance = 0.3,
                    markvar1 = "immune1",
                    markvar2 = "immune2",
                    markvar3 = "background",
                    distribution = "inhom",
                    clust = TRUE)

```

We can plot this using `ggplot`:

```{r}
as_tibble(biv_data) %>%
    ggplot(aes(x,y, color = marks)) +
    geom_point()
```


# Ovarian Dataset

The `ovarian_df` dataset is a small dataframe that contains a snapshot of 5 images of ovarian cancer cells from the `HumanOvarianCancerVP()` dataset in the `VectraPolarisData` package. Each image is represented by a unique sample ID, and within each image, there are multiple cells with their respective x and y coordinates. The dataset includes an `immune` column that indicates whether the cell is an immune cell or a background cell. There is also a `phenotype` column that indicates the type of immune cell, such as "helper t cells", "cytotoxic t cells", "b cells", or "macrophages". The `x` and `y` columns represent the coordinates of the cells in the image.

```{r}
data(ovarian_df)
head(ovarian_df)
```

Since we have a dataframe of multiple images, let's go through, subset our dataframe by id, and plot it.
```{r}
ids <- unique(ovarian_df$sample_id)
marksvar <- "immune"

for (id in ids) {
  df_sub <- ovarian_df %>% filter(sample_id == id)
  w <- convexhull.xy(df_sub$x, df_sub$y)
  pp_obj <- ppp(df_sub$x, df_sub$y, window = w, marks = df_sub[[marksvar]])

  p <- ggplot(as_tibble(pp_obj), aes(x, y, color = marks)) +
    geom_point(size = 0.6) +
    labs(title = paste("Sample:", id)) +
    theme_minimal()

  print(p)
}
```
# KAMP
Now that we have our data, we can use the `kamp()` function to calculate the KAMP expectation and variance for both univariate and bivariate data.

## Univariate

We can use the `kamp()` function to calculate the KAMP expectation for univariate data. In this case, we set `univariate = TRUE` and `variance = FALSE` (the default).

- `univariate = TRUE` calculates the K function for one mark versus background.
- `variance = FALSE` means we only compute the expectation.
- `correction` uses translational correction by default.

### Expectation

```{r}
# Subsets to first image ID
ids <- unique(ovarian_df$sample_id)
marksvar <- "immune"
univ_data <- ovarian_df %>% filter(sample_id == ids[1])
head(univ_data)
w <- convexhull.xy(univ_data$x, univ_data$y)
pp_univ_data <- ppp(univ_data$x, univ_data$y, window = w, marks = univ_data[[marksvar]])

univ_kamp <- kamp(pp_univ_data, 
                  rvals = seq(0, 100, by = 10),
                  univariate = TRUE,
                  marksvar1 = "immune")

univ_kamp
```

```{r}
univ_kamp %>%
  ggplot(aes(x = r)) +
  geom_line(aes(y = theo_csr, color = "theo_csr", linetype = "theo_csr"), size = 1) +
  geom_line(aes(y = kamp, color = "kamp", linetype = "kamp"), size = 1) +
  geom_line(aes(y = k, color = "k", linetype = "k"), size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  scale_color_manual(
    values = c(
      "theo_csr" = "black",
      "kamp" = "blue",
      "k" = "red"
    )
  ) +
  scale_linetype_manual(
    values = c(
      "theo_csr" = "solid",
      "kamp" = "dotted",
      "k" = "dotted"
    )
  ) +
  labs(
    title = "Univariate KAMP Expectation",
    x = "r",
    y = "Value",
    color = "Series",
    linetype = "Series"
  ) +
  theme_minimal()

```

###  Variance

To estimate the variance and compute p-values, set `variance = TRUE`.

**Note:** `variance = TRUE` is not compatible with `thin = TRUE`. If both are set to TRUE, a warning will be thrown and variance will be skipped.

```{r}
univ_kamp_var <- kamp(pp_univ_data,
                       rvals = seq(0, 100, by = 10),
                       univariate = TRUE,
                       marksvar1 = "immune",
                       variance = TRUE)
univ_kamp_var
```

```{r}
univ_kamp_var %>%
  ggplot(aes(x = r, y = var)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") +
  labs(title = "Univariate KAMP Variance", x = "r", y = "Variance") +
  theme_minimal()
```

## Bivariate

### Subsetting Data
For bivariate analysis, we can subset our `ovarian_df` dataframe to include two types of immune cells and background cells. In this example, we will use "helper t cells" and "cytotoxic t cells".
```{r}
ids <- unique(ovarian_df$sample_id)
biv_data <- ovarian_df %>% 
  filter(sample_id == ids[1]) #%>%
  #filter(phenotype %in% c("helper t cells", "cytotoxic t cells", "other")) %>%
  #droplevels()

marksvar <- "phenotype"

head(biv_data)
w <- convexhull.xy(biv_data$x, biv_data$y)
pp_biv_data <- ppp(biv_data$x, biv_data$y, window = w, marks = biv_data[[marksvar]])

biv_data[[marksvar]]

```



### Expectation

To calculate the KAMP expectation for bivariate data, we set `univariate = FALSE` and specify the marks variables for both marks.


```{r}

marks(pp_biv_data)
biv_kamp <- kamp(ppp_obj = pp_biv_data,
                 rvals = seq(0, 100, by = 10),
                 univariate = FALSE,
                 marksvar1 = "helper t cell",
                 marksvar2 = "cytotoxic t cell")
head(biv_kamp)
```

```{r}
biv_kamp %>%
  ggplot(aes(x = r)) +
  geom_line(aes(y = theo_csr, color = "theo_csr", linetype = "theo_csr"), size = 1) +
  geom_line(aes(y = kamp, color = "kamp", linetype = "kamp"), size = 1) +
  geom_line(aes(y = k, color = "k", linetype = "k"), size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  scale_color_manual(
    values = c(
      "theo_csr" = "black",
      "kamp" = "blue",
      "k" = "red"
    )
  ) +
  scale_linetype_manual(
    values = c(
      "theo_csr" = "solid",
      "kamp" = "dotted",
      "k" = "dotted"
    )
  ) +
  labs(
    title = "Bivariate KAMP Expectation",
    x = "r",
    y = "Value",
    color = "Series",
    linetype = "Series"
  ) +
  theme_minimal()
```

### Variance

```{r}
biv_kamp_var <- kamp(ppp_obj = pp_biv_data,
                     rvals = seq(0, 100, by = 10),
                     univariate = FALSE,
                     marksvar1 = "helper t cell",
                     marksvar2 = "cytotoxic t cell",
                     variance = TRUE)
head(biv_kamp_var)
```

```{r}
biv_kamp_var %>%
  ggplot(aes(x = r, y = var)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") +
  labs(title = "Bivariate KAMP Variance", x = "r", y = "Variance") +
  theme_minimal()
```

# KAMP-lite (Thinning)

KAMP-lite refers to running KAMP with a thinned point pattern using `thin = TRUE` and specifying `p_thin` between 0 and 1. This helps with performance on large datasets.

## Univariate

### Expectation
```{r}
ids <- unique(ovarian_df$sample_id)
marksvar <- "immune"
univ_data <- ovarian_df %>% filter(sample_id == ids[1])

w <- convexhull.xy(univ_data$x, univ_data$y)
pp_univ_data <- ppp(univ_data$x, univ_data$y, window = w, marks = univ_data[[marksvar]])


univ_kamp_lite <- kamp(ppp_obj = pp_univ_data,
                       rvals = seq(0, 100, by = 10),
                       univariate = TRUE,
                       marksvar1 = "immune",
                       thin = TRUE,
                       p_thin = 0.3)
univ_kamp_lite
```

```{r}
univ_kamp_lite %>%
  ggplot(aes(x = r)) +
  geom_line(aes(y = theo_csr, color = "theo_csr", linetype = "theo_csr"), size = 1) +
  geom_line(aes(y = kamp, color = "kamp", linetype = "kamp"), size = 1) +
  geom_line(aes(y = k, color = "k", linetype = "k"), size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  scale_color_manual(
    values = c(
      "theo_csr" = "black",
      "kamp" = "blue",
      "k" = "red"
    )
  ) +
  scale_linetype_manual(
    values = c(
      "theo_csr" = "solid",
      "kamp" = "dotted",
      "k" = "dotted"
    )
  ) +
  labs(
    title = "Univariate KAMP-lite Expectation",
    x = "r",
    y = "Value",
    color = "Series",
    linetype = "Series"
  ) +
  theme_minimal()
```

### Variance
```{r}
univ_kamp_lite_var <- kamp(ppp_obj = pp_univ_data,
                            rvals = seq(0, 100, by = 10),
                            univariate = TRUE,
                            marksvar1 = "immune",
                            thin = TRUE,
                            p_thin = 0.3,
                            variance = TRUE) # should display a warning message
univ_kamp_lite_var
```

## Bivariate
```{r}
ids <- unique(ovarian_df$sample_id)
biv_data <- ovarian_df %>% 
  filter(sample_id == ids[1]) #%>%
  #filter(phenotype %in% c("helper t cell", "cytotoxic t cell", "other")) %>%
  #droplevels()

marksvar <- "phenotype"

head(biv_data)
w <- convexhull.xy(biv_data$x, biv_data$y)
pp_biv_data <- ppp(biv_data$x, biv_data$y, window = w, marks = biv_data[[marksvar]])
```

### Expectation
```{r}
biv_kamp_lite <- kamp(ppp_obj = pp_biv_data,
                 rvals = seq(0, 100, by = 10),
                 univariate = FALSE,
                 marksvar1 = "helper t cell",
                 marksvar2 = "cytotoxic t cell",
                 thin = TRUE,
                 p_thin = 0.3)
head(biv_kamp_lite)
```

```{r}
biv_kamp_lite %>%
  ggplot(aes(x = r)) +
  geom_line(aes(y = theo_csr, color = "theo_csr", linetype = "theo_csr"), size = 1) +
  geom_line(aes(y = kamp, color = "kamp", linetype = "kamp"), size = 1) +
  geom_line(aes(y = k, color = "k", linetype = "k"), size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  scale_color_manual(
    values = c(
      "theo_csr" = "black",
      "kamp" = "blue",
      "k" = "red"
    )
  ) +
  scale_linetype_manual(
    values = c(
      "theo_csr" = "solid",
      "kamp" = "dotted",
      "k" = "dotted"
    )
  ) +
  labs(
    title = "Bivariate KAMP-lite Expectation",
    x = "r",
    y = "Value",
    color = "Series",
    linetype = "Series"
  ) +
  theme_minimal()
```

### Variance
```{r}
biv_kamp_lite_var <- kamp(ppp_obj = pp_biv_data,
                          rvals = seq(0, 100, by = 10),
                          univariate = FALSE,
                          marksvar1 = "helper t cell",
                          marksvar2 = "cytotoxic t cell",
                          variance = TRUE,
                          thin = TRUE,
                          p_thin = 0.3) # should display a warning message
head(biv_kamp_lite_var)
```

```{r}
biv_kamp_lite_var %>%
  ggplot(aes(x = r, y = var)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") +
  labs(title = "Bivariate KAMP lite Variance", x = "r", y = "Variance") +
  theme_minimal()
```

