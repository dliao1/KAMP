---
title: "my-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(kperm)
#library(devtools)
library(tidyverse)
library(spatstat.random)
#devtools::load_all()
set.seed(50)
```

# Univariate

## Simulating
```{r}
sim_data <- sim_pp_data(lambda_n = 200, 
                    abundance = 0.3,
                    cell_type1 = "immune",
                    cell_type2 = "background",
                    distribution = "hom",
                    clust = FALSE)
marksvar = "immune"
rvalues = seq(0, 1, length.out = 50)

#w = convexhull.xy(ovarian[["x"]], ovarian[["y"]])

# define pp_obj
# pp_obj = ppp(ovarian[["x"]], ovarian[["y"]], window = w, marks = ovarian[[marksvar]])

pp_obj <- sim_data

df_back <- as.data.frame(pp_obj) %>%
  as_tibble()

df_back


as_tibble(pp_obj) %>%
    ggplot(aes(x,y, color = marks)) +
    geom_point()

```

## Expectation
```{r}
kamp_expec = kamp_expectation(ppp_obj = pp_obj,
                            rvec = rvalues,
                            markvar = marksvar,
                            thin_pct = 0.75) %>% 
  mutate(og_fundiff = k - theo_csr,
         method = "kamp") %>%
  drop_na()

kamp_expec


kamp_expec_mat = kamp_expectation_mat(ppp_obj = pp_obj,
                                    rvec = rvalues,
                                    markvar = marksvar) %>% 
  drop_na()

kamp_expec_mat

```
## Variance
```{r}
kamp_var = kamp_variance(ppp_obj = pp_obj,
                         rvec = rvalues,
                         markvar = marksvar) %>% 
  drop_na()

kamp_var
```

# Bivariate

## Simulating
```{r}
sim_data_biv <- sim_pp_data_biv(lambda_n = 200, 
                    abundance = 0.3,
                    cell_type1 = "immune1",
                    cell_type2 = "immune2",
                    cell_type3 = "background",
                    distribution = "inhom",
                    clust = TRUE)


marksvar = "immune"
rvalues = seq(0, 1, length.out = 50)

pp_obj <- sim_data_biv

df_back <- as.data.frame(pp_obj) %>%
  as_tibble()

df_back


as_tibble(pp_obj) %>%
    ggplot(aes(x,y, color = marks)) +
    geom_point()
```

## Expectation
```{r}
kamp_expec_biv = kamp_expectation_biv(ppp_obj = pp_obj,
                            rvec = rvalues,
                            #markvar = marksvar,
                            thin_pct = 0.5) %>% 
  drop_na()

kamp_expec_biv

kamp_expec_biv_mat = kamp_expectation_biv_mat(ppp_obj = pp_obj,
                                    rvec = rvalues) %>% 
  drop_na()

kamp_expec_biv_mat
```

## Variance
```{r}
kamp_biv_var = kamp_variance_biv(ppp_obj = pp_obj,
                         rvec = rvalues) %>% 
  drop_na()

kamp_biv_var
```

## wtf
```{r}
win <- owin(c(0, 1), c(0, 1))

pp <- rpoispp(lambda = 100, win = win)
marks <- sample(c("immune1", "immune2", "background"), pp$n, replace = TRUE)
marked_pp <- ppp(pp$x, pp$y, window = win, marks = factor(marks))
result <- kamp_variance_biv(marked_pp, markvar1 = "immune1", markvar2 = "immune2")
result

print(names(result))

```



move helpers to utils file

no need for timing stuff
think abt user facing stuff
10000 cells use border correction
thinning percentage = 0
whole separate function for bivariate
unit tests with small spatstat generated datasets
https://github.com/julia-wrobel/registr/blob/master/R/register_fpca.R (documentation example)

SIMULATION SETUP:
can compare traditional K (trans border correction), with Kinhom, Kperm (with 100 permutations), and KAMP


images should be: random, clustered, and inhomogenous (generate and show images)

4 nulls total:
2 null: NO CLUSTERING and CLUSTERING
within each, have homogenous and inhomogenous background


Varied rate of total cells (n) and immune cell abundance (p)
n ∈(100, 500, 1000) # maybe tweak bc i decreased
p ∈(0.1, 0.3, 0.5)

3*3 = 9 images for each subset null hypothesis so 9x4 = 36 total, assuming im avging for the barplots and stuff?

Compare: accuracy (bar plots of fundiff and should be centered at 0) and computation time

can also compare power and type I error # yah idk how i can compare ? if fundiff > 0 thats clustering? are we getting the variance for the perm and KAMP dist and comparing CIs?? need to look at the code


for building site
https://pkgdown.r-lib.org/
pkgdown::build_site()


devtools::document()
devtools::install()
devtools::build_vignettes()


TESTING

usethis::use_test("name of test")
devtools::test()


